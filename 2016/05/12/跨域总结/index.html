<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>跨域总结 | 大钻风的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="所谓跨域，就是JS跨域，JavaScript出于安全方面的考虑，不允许跨域调用其他页面的对象。">
<meta property="og:type" content="article">
<meta property="og:title" content="跨域总结">
<meta property="og:url" content="http://dazuanfeng.github.com/2016/05/12/跨域总结/index.html">
<meta property="og:site_name" content="大钻风的博客">
<meta property="og:description" content="所谓跨域，就是JS跨域，JavaScript出于安全方面的考虑，不允许跨域调用其他页面的对象。">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/1.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/2.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/3.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/4.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/5.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/6.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/7.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/8.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/9.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/10.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/11.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/12.png">
<meta property="og:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/13.png">
<meta property="og:updated_time" content="2016-05-12T11:34:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="跨域总结">
<meta name="twitter:description" content="所谓跨域，就是JS跨域，JavaScript出于安全方面的考虑，不允许跨域调用其他页面的对象。">
<meta name="twitter:image" content="http://dazuanfeng.github.com/img/blogs/cross-origin/1.png">
  
    <link rel="alternative" href="/atom.xml" title="大钻风的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/avatar.jpg">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/avatar.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">大钻风的博客</a></h1>
		</hgroup>

		
		<p class="header-subtitle">后端笔记一箩筐</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/tags/技术/">技术</a></li>
				        
							<li><a href="/tags/生活/">生活</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/工具/" style="font-size: 10px;">工具</a> <a href="/tags/技术/" style="font-size: 20px;">技术</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://costlend.com/">Leechaoqiang的个人Blog</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">软件工程科班技术宅男一名。擅长Java服务端编程，语言Java,Scala,Python，前端略懂，运维略懂。有道笔记上积累了很多的文章，以后会慢慢整理出来发到这里。欢迎收藏，有问题欢迎留言评论！</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">大钻风的博客</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/avatar.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">大钻风的博客</h1>
			</hgroup>
			
			<p class="header-subtitle">后端笔记一箩筐</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/tags/技术/">技术</a></li>
		        
					<li><a href="/tags/生活/">生活</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo">weibo</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-跨域总结" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/12/跨域总结/" class="article-date">
  	<time datetime="2016-05-12T09:29:19.000Z" itemprop="datePublished">2016-05-12</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      跨域总结
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术/">技术</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>所谓跨域，就是JS跨域，JavaScript出于安全方面的考虑，不允许跨域调用其他页面的对象。</p>
<a id="more"></a>
<p>这里介绍一下服务端跨域的总结</p>
<p>参考教程：</p>
<blockquote>
<p><a href="https://spring.io/guides/gs/rest-service-cors/" target="_blank" rel="external">https://spring.io/guides/gs/rest-service-cors/</a></p>
<p><a href="http://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html" target="_blank" rel="external">http://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html</a></p>
<p><a href="http://blog.csdn.net/suhenhappy/article/details/18043241" target="_blank" rel="external">http://blog.csdn.net/suhenhappy/article/details/18043241</a></p>
</blockquote>
<p>所谓跨域，就是JS跨域，JavaScript出于安全方面的考虑，不允许跨域调用其他页面的对象。<br>首先什么是跨域，简单地理解就是因为JavaScript同源策略的限制，a.com 域名下的js无法操作b.com或是c.a.com域名下的对象。更详细的说明可以看下表：</p>
<table>
<thead>
<tr>
<th style="text-align:left">URL</th>
<th style="text-align:center">说明</th>
<th style="text-align:center">是否允许通信</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="http://www.a.com/a.js" target="_blank" rel="external">http://www.a.com/a.js</a> <a href="http://www.a.com/b.js" target="_blank" rel="external">http://www.a.com/b.js</a></td>
<td style="text-align:center">同一域名下</td>
<td style="text-align:center">允许</td>
</tr>
<tr>
<td style="text-align:left"><a href="http://www.a.com/lab/a.js" target="_blank" rel="external">http://www.a.com/lab/a.js</a> <a href="http://www.a.com/script/b.js" target="_blank" rel="external">http://www.a.com/script/b.js</a></td>
<td style="text-align:center">同一域名下不同文件夹</td>
<td style="text-align:center">允许</td>
</tr>
<tr>
<td style="text-align:left"><a href="http://www.a.com:8000/a.js" target="_blank" rel="external">http://www.a.com:8000/a.js</a> <a href="http://www.a.com/b.js" target="_blank" rel="external">http://www.a.com/b.js</a></td>
<td style="text-align:center">同一域名，不同端口</td>
<td style="text-align:center">不允许</td>
</tr>
<tr>
<td style="text-align:left"><a href="http://www.a.com/a.js" target="_blank" rel="external">http://www.a.com/a.js</a> <a href="https://www.a.com/b.js" target="_blank" rel="external">https://www.a.com/b.js</a></td>
<td style="text-align:center">同一域名，不同协议</td>
<td style="text-align:center">不允许</td>
</tr>
<tr>
<td style="text-align:left"><a href="http://www.a.com/a.js" target="_blank" rel="external">http://www.a.com/a.js</a> <a href="http://70.32.92.74/b.js" target="_blank" rel="external">http://70.32.92.74/b.js</a></td>
<td style="text-align:center">域名和域名对应ip</td>
<td style="text-align:center">不允许</td>
</tr>
<tr>
<td style="text-align:left"><a href="http://www.a.com/a.js" target="_blank" rel="external">http://www.a.com/a.js</a> <a href="http://script.a.com/b.js" target="_blank" rel="external">http://script.a.com/b.js</a></td>
<td style="text-align:center">主域相同，子域不同</td>
<td style="text-align:center">不允许</td>
</tr>
<tr>
<td style="text-align:left"><a href="http://www.a.com/a.js" target="_blank" rel="external">http://www.a.com/a.js</a> <a href="http://a.com/b.js" target="_blank" rel="external">http://a.com/b.js</a></td>
<td style="text-align:center">同一域名，不同二级域名（同上）</td>
<td style="text-align:center">不允许（cookie这种情况下也不允许访问）</td>
</tr>
<tr>
<td style="text-align:left"><a href="http://www.cnblogs.com/a.js" target="_blank" rel="external">http://www.cnblogs.com/a.js</a> <a href="http://www.a.com/b.js" target="_blank" rel="external">http://www.a.com/b.js</a></td>
<td style="text-align:center">不同域名</td>
<td style="text-align:center">不允许</td>
</tr>
</tbody>
</table>
<p>特别注意两点：</p>
<p>第一，如果是协议和端口造成的跨域问题“前台”是无能为力的，</p>
<p>第二：在跨域问题上，域仅仅是通过“URL的首部”来识别而不会去尝试判断相同的ip地址对应着两个域或两个域是否在同一个ip上。<br>“URL的首部”指window.location.protocol +window.location.host，也可以理解为“Domains, protocols and ports must match”。</p>
<p>解决的方式有好几种：</p>
<ol>
<li>服务端nginx配置</li>
<li>JSONP</li>
<li>CORS</li>
</ol>
<p>下面会进行介绍。</p>
<p>环境搭建，两台服务器分别安装了nginx(openresty)和JDK8.</p>
<p>首先有两个域名：</p>
<blockquote>
<p>192.168.15.21 cluster1.zhangdemo.com</p>
<p>192.168.15.22 cluster2.zhangdemo.com</p>
</blockquote>
<p>本机是192.168.15.1,nginx配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log  logs/error.log;</span><br><span class="line">error_log  logs/error.log  notice;</span><br><span class="line">error_log  logs/error.log  info;</span><br><span class="line">#pid        logs/nginx.pid;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</span><br><span class="line">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</span><br><span class="line">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</span><br><span class="line">    access_log  logs/access.log  main;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    #tcp_nopush     on;</span><br><span class="line"></span><br><span class="line">    #keepalive_timeout  0;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    #gzip  on;</span><br><span class="line">    upstream cluster1_proxy &#123;</span><br><span class="line">        server 127.0.0.1:8080;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  cluster1.zhangdemo.com;</span><br><span class="line">        location ~</span><br><span class="line">        &#123;</span><br><span class="line">           proxy_pass http://cluster1_proxy;</span><br><span class="line">           proxy_redirect off;</span><br><span class="line">           proxy_set_header HOST $host;</span><br><span class="line">           proxy_set_header X-Real-OP $remote_addr;</span><br><span class="line">           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">           proxy_temp_file_write_size 2048k;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外一台配置相仿，该配置的主要作用是将机器的80端口反向代理到8080端口上。</p>
<p>创建一个只有web模块的spring boot项目：web-app0</p>
<p>创建一个Greetting的类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.crossdomain.webapp0.beans;</span><br><span class="line"></span><br><span class="line">public class Greeting &#123;</span><br><span class="line">private final long id;</span><br><span class="line">    private final String content;</span><br><span class="line"></span><br><span class="line">    public Greeting(long id, String content) &#123;</span><br><span class="line">this.id = id;</span><br><span class="line">        this.content = content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public long getId() &#123;</span><br><span class="line">return id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public String getContent() &#123;</span><br><span class="line">return content;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个GreetingController：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.crossdomain.webapp0.controllers;</span><br><span class="line"></span><br><span class="line">import com.crossdomain.webapp0.beans.Greeting;</span><br><span class="line">import org.slf4j.Logger;</span><br><span class="line">import org.slf4j.LoggerFactory;</span><br><span class="line">import org.springframework.stereotype.Controller;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">import org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line">import org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.atomic.AtomicLong;</span><br><span class="line"></span><br><span class="line">@Controller</span><br><span class="line">public class GreetingController &#123;</span><br><span class="line"></span><br><span class="line">private Logger logger = LoggerFactory.getLogger(GreetingController.class);</span><br><span class="line">    private static final String template = &quot;你好, %s!&quot;;</span><br><span class="line">    private final AtomicLong counter = new AtomicLong();</span><br><span class="line"></span><br><span class="line">@RequestMapping(&quot;/greeting&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public Greeting greeting(@RequestParam(required = false,defaultValue = &quot;世界&quot;) String name)&#123;</span><br><span class="line">logger.info(&quot;request for greeting&quot;);</span><br><span class="line">        return new Greeting(counter.incrementAndGet(), String.format(template, name));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如此启动spring boot之后访问<a href="http://localhost:8080/greeting?name=张三" target="_blank" rel="external">http://localhost:8080/greeting?name=张三</a></p>
<p><img src="/img/blogs/cross-origin/1.png" alt=""></p>
<p>继续添加首页：</p>
<p>在resources目录下创建public目录，添加index.html和hello.js</p>
<p>index.html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Hello CORS&lt;/title&gt;</span><br><span class="line">    &lt;script src=&quot;jquery-1.11.3.min.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script src=&quot;hello.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;p class=&quot;greeting-id&quot;&gt;The ID is &lt;/p&gt;</span><br><span class="line">    &lt;p class=&quot;greeting-content&quot;&gt;The content is &lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>hello.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$(document).ready(function() &#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: &quot;http://cluster1.zhangdemo.com/greeting?name=李四&quot;</span><br><span class="line">    &#125;).then(function(data, status, jqxhr) &#123;</span><br><span class="line">        $(&apos;.greeting-id&apos;).append(data.id);</span><br><span class="line">        $(&apos;.greeting-content&apos;).append(data.content);</span><br><span class="line">        console.log(jqxhr);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>将该程序打包放到cluster1.zhangdemo.com和cluster2.zhangdemo.com机器上。</p>
<p>打包命令 mvn clean package</p>
<p>分别运行java -jar web-app0-0.0.1-SNAPSHOT.jar启动web项目</p>
<p><img src="/img/blogs/cross-origin/2.png" alt=""></p>
<p>分别访问<br><strong><a href="http://cluster1.zhangdemo.com/greeting?name=zhangsan" target="_blank" rel="external">http://cluster1.zhangdemo.com/greeting?name=zhangsan</a></strong><br>和<br><strong><a href="http://cluster2.zhangdemo.com/greeting?name=zhangsan" target="_blank" rel="external">http://cluster2.zhangdemo.com/greeting?name=zhangsan</a></strong><br>均能正常返回</p>
<p><img src="/img/blogs/cross-origin/3.png" alt=""></p>
<p><img src="/img/blogs/cross-origin/4.png" alt=""></p>
<p>访问<a href="http://cluster1.zhangdemo.com/也能正常有结果：" target="_blank" rel="external">http://cluster1.zhangdemo.com/也能正常有结果：</a></p>
<p><img src="/img/blogs/cross-origin/5.png" alt=""></p>
<p>但是访问<a href="http://cluster2.zhangdemo.com/就不行了：" target="_blank" rel="external">http://cluster2.zhangdemo.com/就不行了：</a></p>
<p><img src="/img/blogs/cross-origin/6.png" alt=""></p>
<p>这就是跨域导致的。</p>
<p>查看该页面的请求即发现，有一个请求是从<strong>cluster2.zhangdemo.com往cluster1.zhangdemo.com</strong>请求的。</p>
<p><img src="/img/blogs/cross-origin/7.png" alt=""></p>
<p>解决办法第一种就是在cluster1.zhangdemo.com的nginx配置上添加如下的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">location ~</span><br><span class="line">        &#123;</span><br><span class="line">           add_header &apos;Access-Control-Allow-Origin&apos; &apos;http://cluster2.zhangdemo.com&apos;;</span><br><span class="line">           add_header &apos;Access-Control-Allow-Credentials&apos; &apos;true&apos;;</span><br><span class="line">           add_header &apos;Access-Control-Allow-Methods&apos; &apos;GET&apos;;</span><br><span class="line">           proxy_pass http://cluster1_proxy;</span><br><span class="line">           proxy_redirect off;</span><br><span class="line">           proxy_set_header HOST $host;</span><br><span class="line">           proxy_set_header X-Real-OP $remote_addr;</span><br><span class="line">           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">           proxy_temp_file_write_size 2048k;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p><strong>Access-Control-Allow-Origin</strong>表示授权访问的域，允许任何域可配置成*</p>
<p>刷新<a href="http://cluster2.zhangdemo.com/即可正常访问：" target="_blank" rel="external">http://cluster2.zhangdemo.com/即可正常访问：</a></p>
<p><img src="/img/blogs/cross-origin/8.png" alt=""></p>
<p>从上面的图中可以看到返回头里面添加了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http://cluster2.zhangdemo.com</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br><span class="line">Access-Control-Allow-Methods: GET</span><br></pre></td></tr></table></figure>
<p>=====================补充==========================</p>
<p>关于这种方式的跨域配置其实很广泛：</p>
<p>比如支付宝的首页<a href="https://my.alipay.com/portal/i.htm" target="_blank" rel="external">https://my.alipay.com/portal/i.htm</a> ,登录之后的页面加载的资源有很多，重点关注跨域的资源，比如</p>
<p><img src="/img/blogs/cross-origin/9.png" alt=""></p>
<p>这里采用的就是简单的服务端的如上面的配置。</p>
<p>但是也有一些并不是这么做的，比如下面的这个资源，这个是获取头像的图片的请求。服务端没有Access-Control-Allow-Origin的响应头返回，但是带上了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie:spanner=eJJ9OVkw6NwuVEZhyKTeGXW6kVdbVTx3Xt2T4qEYgj0=;path=/;secure;</span><br></pre></td></tr></table></figure>
<p>这样的头，而且请求头也带上了Cookie信息。</p>
<p><img src="/img/blogs/cross-origin/10.png" alt=""></p>
<p>另外还发现了另外一类：</p>
<p><img src="/img/blogs/cross-origin/11.png" alt=""></p>
<p>请求和响应头没有跨域的痕迹，但是返回的结果是带有callback函数的，这种很明显应该是JSONP实现的。</p>
<p><img src="/img/blogs/cross-origin/12.png" alt=""></p>
<p>==================================结束补充==============================</p>
<p>除了这种服务端简单配置的方式，还有另外一种方式可以实现跨域: CORS(Cross-Origin Resource Sharing 跨域资源共享)</p>
<p>下面来介绍一下具体做法。首先cluster2.zhangdemo.com上的程序可以保持不变。</p>
<p>修改在cluster1.zhangdemo.com上部署的程序。具体如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@CrossOrigin(origins = &quot;http://cluster2.zhangdemo.com&quot;)</span><br><span class="line">    @RequestMapping(&quot;/greeting&quot;)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    public Greeting greeting(@RequestParam(required = false,defaultValue = &quot;世界&quot;) String name)&#123;</span><br><span class="line">        logger.info(&quot;request for greeting&quot;);</span><br><span class="line">        return new Greeting(counter.incrementAndGet(), String.format(template, name));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>只需要在方法前面加上@CrossOrigin(origins = “<a href="http://cluster2.zhangdemo.com" target="_blank" rel="external">http://cluster2.zhangdemo.com</a>“) 跨域的配置即可。</p>
<p>对于@CrossOrigin 注解，这里介绍一下，默认的是允许所有domain的。可以配置的参数有origins, methods, allowedHeaders, exposedHeaders, allowCredentials和maxAge。</p>
<p>另外也可以在class上添加注解。</p>
<p>另外，如果想要做全局的配置的话，添加一个配置类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line">    public WebMvcConfigurer corsConfigurer() &#123;</span><br><span class="line">        return new WebMvcConfigurerAdapter() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void addCorsMappings(CorsRegistry registry) &#123;</span><br><span class="line">                registry.addMapping(&quot;/greeting&quot;).allowedOrigins(&quot;http://cluster2.zhangdemo.com&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/blogs/cross-origin/13.png" alt=""></p>
<p>重新部署启动cluster1上的程序，可以看到上面的结果，同样添加了两个response的头：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin: http://cluster2.zhangdemo.com</span><br><span class="line">Access-Control-Allow-Credentials: true</span><br></pre></td></tr></table></figure>
<p>文章完结。</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/05/12/markdown教程/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">markdown教程</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>








</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 大钻风的博客
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>